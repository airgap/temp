#!/bin/bash

PUSH_FLAG=""
REGISTRY="registry.digitalocean.com/lyku"  # Changed to DigitalOcean registry
REPO="lyku"             # Added repository name

# Parse arguments
for arg in "$@"; do
    if [ "$arg" == "--push" ]; then
        PUSH_FLAG="--push"
    elif [ "$arg" != "$1" ]; then  # If not the route name and not --push, treat as registry
        REGISTRY=$arg
    fi
done

# Build the image
docker build \
    --quiet \
    -f docker/templates/route.Dockerfile \
    -t $REGISTRY/$REPO:plumber \
    .
    # --provenance=mode=max \

# Push the image
if [ -n "$PUSH_FLAG" ]; then 
    # If running with sudo, use the original user's Docker config
    if [ -n "$SUDO_USER" ]; then
        DOCKER_CONFIG="/home/$SUDO_USER/.docker"
        if [ -f "$DOCKER_CONFIG/config.json" ]; then
            echo "Using Docker credentials from $SUDO_USER"
            docker --config "$DOCKER_CONFIG" push --quiet $REGISTRY/$REPO:plumber
        else
            echo "Error: Docker credentials not found. Please run 'docker login' as your regular user first."
            exit 1
        fi
    else
        docker push --quiet $REGISTRY/$REPO:plumber
    fi
fi 